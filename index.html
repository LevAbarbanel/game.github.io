<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hilit & Lev Counter Widget</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f5f5f5;
        }

        .widget-container {
            background-color: #333333;
            border-radius: 16px;
            padding: 30px;
            width: 400px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #666666;
            color: #FFFFFF;
        }

        .widget-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 24px;
        }

        .counter-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .counter-label {
            font-size: 24px;
            text-align: center;
            flex-grow: 1;
            padding: 10px 0;
        }

        .counter-button {
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            cursor: pointer;
            color: white;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .counter-button:hover {
                background-color: rgba(255, 255, 255, 0.1);
                border-radius: 50%;
            }

            .counter-button:active {
                background-color: rgba(255, 255, 255, 0.2);
            }

        .main-counter-button {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

            .main-counter-button:hover {
                background-color: rgba(255, 255, 255, 0.2);
            }

        .loading-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            border-radius: 16px;
            display: none;
        }

        .widget-wrapper {
            position: relative;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="widget-wrapper">
        <div class="widget-container">
            <div class="widget-title">המשחק המשגע</div>

            <div class="counter-row">
                <button class="counter-button" id="hilit-down">-</button>
                <div class="counter-label" id="hilit-label">הילית: 0</div>
                <button class="counter-button" id="hilit-up">+</button>
            </div>

            <div class="counter-row">
                <button class="counter-button" id="lev-down">-</button>
                <div class="counter-label" id="lev-label">לב: 0</div>
                <button class="counter-button" id="lev-up">+</button>
            </div>
        </div>
        <div class="loading-indicator">
            <div class="spinner"></div>
            <div>מתעדכן...</div>
        </div>
    </div>

    <script>
        // API URL from the original code
        const API_URL = "https://x8ki-letl-twmt.n7.xano.io/api:sizyTD43/hilit";

        // Local counters for immediate UI feedback (like in the original)
        let localHilitCounter = 0;
        let localLevCounter = 0;
        let recordId = 1;
        let updateInProgress = false;
        let isInitialized = false;

        // DOM elements
        const hilitLabel = document.getElementById('hilit-label');
        const levLabel = document.getElementById('lev-label');
        const hilitUpBtn = document.getElementById('hilit-up');
        const hilitDownBtn = document.getElementById('hilit-down');
        const levUpBtn = document.getElementById('lev-up');
        const levDownBtn = document.getElementById('lev-down');
        const hilitMainBtn = document.getElementById('hilit-main-btn');
        const levMainBtn = document.getElementById('lev-main-btn');
        const loadingIndicator = document.querySelector('.loading-indicator');

        // Update widget UI with new counter values
        function updateWidgetUI() {
            hilitLabel.textContent = `הילית: ${localHilitCounter}`;
            levLabel.textContent = `לב: ${localLevCounter}`;
        }

        // Show/hide loading indicator
        function setLoading(isLoading) {
            loadingIndicator.style.display = isLoading ? 'flex' : 'none';
            updateInProgress = isLoading;
        }

        // Fetch counter data from API
        async function fetchCounterData() {
            try {
                console.log("Fetching data from API");
                const response = await fetch(API_URL);

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                console.log("API Response:", data);

                if (data && data.length > 0) {
                    const counterData = data[0];
                    recordId = counterData.id;
                    localHilitCounter = counterData.HilitCounter;
                    localLevCounter = counterData.LevCounter;
                    isInitialized = true;
                    updateWidgetUI();
                    return { hilitCounter: localHilitCounter, levCounter: localLevCounter, id: recordId };
                } else {
                    throw new Error("Empty data returned from API");
                }
            } catch (error) {
                console.error("Error fetching data:", error);
                // If we have local values, continue showing those during API failures
                if (isInitialized) {
                    updateWidgetUI();
                }
                throw error;
            }
        }

        // Update counter via API
        async function updateCounter(isHilit, isIncrement) {
            if (updateInProgress) {
                console.log("Update already in progress, ignoring click");
                return;
            }

            setLoading(true);

            // Update local counters immediately for responsive UI
            if (isHilit) {
                if (isIncrement) {
                    localHilitCounter++;
                } else if (localHilitCounter > 0) {
                    localHilitCounter--;
                }
            } else {
                if (isIncrement) {
                    localLevCounter++;
                } else if (localLevCounter > 0) {
                    localLevCounter--;
                }
            }

            // Update UI immediately with local values
            updateWidgetUI();

            try {
                // Try to get current values from API first to reduce race conditions
                const currentData = await fetchCounterData();

                // Calculate new values based on the action
                let newHilitCounter = isHilit
                    ? (isIncrement ? currentData.hilitCounter + 1 : Math.max(0, currentData.hilitCounter - 1))
                    : currentData.hilitCounter;

                let newLevCounter = !isHilit
                    ? (isIncrement ? currentData.levCounter + 1 : Math.max(0, currentData.levCounter - 1))
                    : currentData.levCounter;

                // Prepare PATCH request (as in original code)
                const updateUrl = `${API_URL}/${currentData.id}`;
                console.log(`Updating counter at URL: ${updateUrl}`);

                const response = await fetch(updateUrl, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        HilitCounter: newHilitCounter,
                        LevCounter: newLevCounter
                    })
                });

                if (response.ok) {
                    const updatedData = await response.json();
                    console.log("Update successful:", updatedData);

                    // Update local counters with values from API response
                    localHilitCounter = updatedData.HilitCounter;
                    localLevCounter = updatedData.LevCounter;
                    updateWidgetUI();
                } else {
                    // On error, refresh from the API to ensure we stay in sync
                    console.error(`API update failed with status: ${response.status}`);
                    await fetchCounterData();
                }
            } catch (error) {
                console.error("Error updating counter:", error);

                // Try to refresh from API to stay in sync
                try {
                    await fetchCounterData();
                } catch (refreshError) {
                    console.error("Failed to refresh after error:", refreshError);
                }
            } finally {
                setLoading(false);
            }
        }

        // Initialize event listeners
        function initEventListeners() {
            // Main buttons removed

            // Up/down buttons
            hilitUpBtn.addEventListener('click', () => updateCounter(true, true));
            hilitDownBtn.addEventListener('click', () => updateCounter(true, false));
            levUpBtn.addEventListener('click', () => updateCounter(false, true));
            levDownBtn.addEventListener('click', () => updateCounter(false, false));
        }

        // Fetch data initially
        async function initialize() {
            setLoading(true);
            try {
                await fetchCounterData();
            } catch (error) {
                console.error("Initialization error:", error);
            } finally {
                setLoading(false);
            }
        }

        // Set up periodic refresh (like in original)
        function startPeriodicRefresh() {
            setInterval(async () => {
                if (!updateInProgress) {
                    try {
                        await fetchCounterData();
                    } catch (error) {
                        console.error("Error in periodic refresh:", error);
                    }
                }
            }, 6000); // 6 seconds, like in original
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initEventListeners();
            initialize();
            startPeriodicRefresh();
        });
    </script>
</body>
</html>
